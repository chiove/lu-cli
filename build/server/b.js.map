{"version":3,"sources":["webpack:///./src/utils/get-initial-props.js","webpack:///./src/pages/b.js"],"names":["_this","_isPop","_isMount","popStateCallback","SourceComponent","initialData","canClientFetch","this","match","location","res","window","props","history","action","staticContext","React","b","useState","list","setList","className","onClick","a","axios","key","item","ctx","getInitialProps"],"mappings":"y7BAIA,IAAIA,EAAJ,KACIC,GAAJ,EACIC,GAAJ,EACMC,EAAmB,WACnBH,GAASA,EAAb,kBACEC,KACA,GACED,sBAKS,aAAAI,GAAe,6CAC5B,cAAmB,0BACjB,kBACA,MAAa,CACXC,YADW,GAEXC,gBAAgB,GAJD,EADS,2JAkBAC,KAlBA,MAkBnBC,EAlBmB,QAkBZC,EAlBY,YAmBdL,EAnBc,gDAmB0BA,EAAA,gBAAgC,CAACI,MAAD,EAAQC,aAnBlE,wDAmBpBC,EAnBoB,KAoB1BH,KAAA,SAAc,CACZF,YADY,EAEZC,gBAAgB,IAtBQ,+NAkC1BJ,GAlC0B,EAmCtBS,OAAJ,iBACEX,EADyB,KAGzBW,sCACA,GACEJ,KAAA,qBAImBA,KAAKK,MAAMC,SA5CR,SA4CmBN,KAAKK,MAAMC,QAAQC,SACzCH,OA7CG,+CA8ClBJ,KA9CkB,4JAmD1BN,GADqB,EAErBC,GAFqB,IAlDK,+BAwD1B,IAAMU,E,iWAAQ,CAAH,CACTP,YAAa,IACVE,KAFL,OAmBA,OAXMA,KAAKK,MAAT,gBAA8BA,cAAoBL,KAAKK,MAAMG,cAAcV,aAA7CO,IAWzB,oBAAP,MA3E0B,wIAWdR,EAXc,gDAW0BA,kBAX1B,kEAWpBM,EAXoB,wHAA8BM,IAA9B,a,8JCVxBC,EAAI,SAACL,GAAU,MACUM,mBADV,sBACZC,OADY,WACDC,EADC,KAEnB,OAAQ,6BACN,yBACEC,UADF,QAEEC,QAAO,cAAE,4BAAAC,EAAA,sEACWC,IADX,uBACDd,EADC,OAEPU,EAAQD,SAAYT,OAApBU,OAFO,4CAMPR,eAAqBA,mBATnB,GAYN,6BAEIO,EAAA,KAAS,qBAAe,0BAAMM,IAAKA,GAAMC,EAAhC,YAMjBT,iDAAoB,+BAAAM,EAAA,mFAEVb,EAFU,yBAGTA,EAHS,6BAKEiB,yBALF,wBAKVjB,EALU,wEAApBO,sDASeW,sBAAf","file":"b.js","sourcesContent":["// 高阶组件 用于提取重复逻辑\n\nimport React from 'react';\n\nlet _this = null;\nlet _isPop = false;\nlet _isMount = false;\nconst popStateCallback = () => {\n  if (_this && _this.getInitialProps) {\n    _isPop = true;\n    if (_isMount) {\n      _this.getInitialProps();\n    }\n  }\n};\n\nexport default SourceComponent => class HoComponent extends React.Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      initialData: {},\n      canClientFetch: false,\n    };\n  }\n\n  // 用于服务端调用\n  static async getInitialProps(ctx) {\n    const res = SourceComponent.getInitialProps ? await SourceComponent.getInitialProps(ctx) : {};\n    return res;\n  }\n\n  // 用于封装处理\n  async getInitialProps() {\n    // ssr首次进入页面以及csr/ssr切换路由时才调用组件的getInitialProps方法\n    const {match, location} = this.props;\n    const res = SourceComponent.getInitialProps ? await SourceComponent.getInitialProps({match, location}) : {};\n    this.setState({\n      initialData: res,\n      canClientFetch: true,\n    });\n\n    // console.log('getInitialProps');\n    // let { tdk } = res.page;\n    // if (tdk) {\n    //     document.title = tdk.title;\n    // }\n  }\n\n  async componentDidMount() {\n    // 注册事件，用于在页面回退和前进的时候触发\n    _isMount = true;// 组件挂载完成\n    if (window.__USE_SERVER__) {\n      _this = this;\n      // 注册事件\n      window.addEventListener('popstate', popStateCallback);\n      if (_isPop) { // 如果前进或者后退 则需要异步获取数据\n        this.getInitialProps();\n      }\n    }\n\n    const canClientFetch = this.props.history && this.props.history.action === 'PUSH';\n    if (canClientFetch || !window.__USE_SERVER__) {\n      await this.getInitialProps();\n    }\n  }\n\n  componentWillUnmount() {\n    _isPop = false; // 重置为未触发\n    _isMount = false;// 重置为未挂载\n  }\n\n  render() {\n    const props = {\n      initialData: {},\n      ...this.props,\n    };\n\n\n    if (__SERVER__) {\n      // 服务端渲染\n      if (this.props.staticContext) props.initialData = this.props.staticContext.initialData || {};\n    } else {\n      // 客户端渲染\n      const {canClientFetch, initialData} = this.state;\n      if (canClientFetch) { // 需要异步请求数据\n        props.initialData = initialData || {};\n      } else {\n        props.initialData = window.__INITIAL_DATA__;\n        window.__INITIAL_DATA__ = null;\n      }\n    }\n    return <SourceComponent {...props} />;\n  }\n};\n","import React, {useState} from 'react';\nimport axios from 'axios';\nimport {Link} from 'react-router-dom';\nimport getInitialProps from 'src/utils/get-initial-props';\nimport './b.less';\n\nconst b = (props) => {\n  const [list = [], setList] = useState([]);\n  return (<div>\n    <div\n      className=\"test1\"\n      onClick={async () => {\n        const res = await axios('/api/getList');\n        setList(list.concat(res.data.data));\n      }}\n    >\n      {\n        props.initialData && props.initialData.data.a\n      }\n    </div>\n    <div>\n      {\n        list.map((item, key) => <span key={key}>{item.name}</span>)\n      }\n    </div>\n  </div>);\n};\n\nb.getInitialProps = async (ctx) => {\n  if (__CLIENT__) {\n    const res = await axios('/api/getDetails');\n    return res.data;\n  } else {\n    const res = await ctx.controllers.test.index.details();\n    return res;\n  }\n};\nexport default getInitialProps(b);\n"],"sourceRoot":""}